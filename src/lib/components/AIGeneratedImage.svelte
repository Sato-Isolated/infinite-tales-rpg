<script lang="ts">
	import { useLocalStorage } from '../state/useLocalStorage.svelte';
	import isEqual from 'lodash.isequal';
	import { onMount } from 'svelte';
	import LoadingIcon from '$lib/components/LoadingIcon.svelte';

	let {
		storageKey = '',
		showGenerateButton = true,
		buttonClassesString = 'btn-md',
		showLoadingSpinner = true,
		noLogo = false,
		enhance = false,
		onClickGenerate = () => {},
		resetImageState = false,
		imagePrompt = '',
		imageClassesString = 'm-auto h-[296px] sm:h-[512px]'
	} = $props();

	const initialImageState = {
		prompt: imagePrompt?.trim(),
		isGenerating: false,
		link: {
			title:
				'Vegas Bleeds Neon, CC BY-SA 3.0 https://creativecommons.org/licenses/by-sa/3.0>, via Wikimedia Commons',
			href: 'https://commons.wikimedia.org/wiki/File:Placeholder_female_superhero_c.png'
		},
		image: {
			alt: 'Placeholder female superhero c',
			src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/Placeholder_female_superhero_c.png/256px-Placeholder_female_superhero_c.png?20110305190235'
		}
	};
	let imageState = $state({ value: { ...initialImageState } });
	if (storageKey) {
		imageState = useLocalStorage(storageKey, { ...initialImageState, prompt: imagePrompt?.trim() });
	}

	// Ensure prop drives prompt even when localStorage has an older value.
	$effect(() => {
		const trimmed = imagePrompt?.trim();
		if (trimmed && imageState.value.prompt !== trimmed) {
			// Update prompt from prop; allow auto-regeneration logic to handle fetching.
			imageState.value.prompt = trimmed;
			// Reset generation marker so change is recognized if previous prompt matched lastGeneratedPrompt.
			if (!showGenerateButton) {
				imageState.value.isGenerating = false;
				lastGeneratedPrompt = '';
			}
		}
	});

	$effect(() => {
		if (resetImageState) {
			imageState.value = {
				...initialImageState,
				prompt: imagePrompt?.trim(),
				isGenerating: false,
				image: { ...initialImageState.image }
			};
			lastGeneratedPrompt = '';
			resetImageState = false;
		}
	});

	// Track last generated prompt to know when to regenerate automatically
	let lastGeneratedPrompt = $state('');
	$effect(() => {
		const currentPrompt = imageState.value.prompt?.trim();
		if (
			!showGenerateButton &&
			currentPrompt &&
			currentPrompt.length > 3 &&
			currentPrompt !== lastGeneratedPrompt &&
			!imageState.value.isGenerating
		) {
			// Reset to placeholder while loading to avoid stale previous image flashing
			imageState.value.isGenerating = true;
			lastGeneratedPrompt = currentPrompt;
			replaceWithAiGenerated();
		}
	});

	function replaceWithAiGenerated() {
		if (imageState.value.prompt?.trim()) {
			imageState.value.isGenerating = true;
			const aiGeneratedImage = new Image();
			//wait till ai has generated image
			aiGeneratedImage.onload = function () {
				const newImgState = {
					prompt: imageState.value.prompt,
					isGenerating: false,
					link: {
						...initialImageState.link,
						title: '',
						href: aiGeneratedImage.src
					},
					image: {
						...initialImageState.image,
						src: aiGeneratedImage.src,
						alt: imagePrompt
					}
				};
				imageState.value = newImgState;
			};
			// @ts-expect-error wrong type here dont care
			aiGeneratedImage.onerror = aiGeneratedImage.onload;

			aiGeneratedImage.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(imageState.value.prompt)}?width=768&height=768&enhance=${enhance}&nologo=${noLogo}`;
		}
	}

	onMount(() => {
		const imageStateSnapshot = $state.snapshot(imageState.value);
		if (
			imageState.value.isGenerating ||
			(!showGenerateButton && isEqual(initialImageState, imageStateSnapshot))
		) {
			replaceWithAiGenerated();
		}
	});
</script>

{#if showLoadingSpinner && imageState.value.isGenerating}
	<div class={'content-center ' + imageClassesString}>
		<LoadingIcon />
	</div>
{/if}

<img
	class:hidden={showLoadingSpinner && imageState.value.isGenerating}
	class={imageClassesString}
	alt={imageState.value.image.alt}
	src={imageState.value.image.src}
/>

{#if showGenerateButton}
	<button
		class="btn btn-accent mt-3 {buttonClassesString}"
		disabled={imageState.value.isGenerating}
		onclick={(e) => {
			replaceWithAiGenerated();
			onClickGenerate(e);
		}}
	>
		Generate Image
	</button>
{/if}
